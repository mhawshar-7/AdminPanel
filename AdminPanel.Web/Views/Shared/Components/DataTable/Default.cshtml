@using AdminPanel.Web.Models.DataTable
@model AdminPanel.Web.Models.DataTable.DataTableConfiguration
@{
    // Unique identifier for the table, used for JavaScript targeting.
    var tableId = Model.Id;
    // Flags to conditionally render parts of the table.
    var hasCheckboxes = Model.ShowCheckboxes;
    var hasActions = Model.ActionButtons.Any();

    // URLs for row actions, initialized as empty strings.
    var editUrl = "";
    var deleteUrl = "";

    // If action buttons are configured, resolve their URLs.
    if (hasActions)
    {
        var editButton = Model.ActionButtons.FirstOrDefault(b => b.Action?.ToLower() == "edit");
        var deleteButton = Model.ActionButtons.FirstOrDefault(b => b.Action?.ToLower() == "remove" || b.Action?.ToLower() == "delete");

        if (editButton != null && !string.IsNullOrEmpty(editButton.Controller) && !string.IsNullOrEmpty(editButton.Action))
        {
            editUrl = Url.Action(editButton.Action, editButton.Controller);
        }

        if (deleteButton != null && !string.IsNullOrEmpty(deleteButton.Controller) && !string.IsNullOrEmpty(deleteButton.Action))
        {
            deleteUrl = Url.Action(deleteButton.Action, deleteButton.Controller);
        }
    }
}

@if (Model.WrapInCard)
{
    // The entire component can be wrapped in a card for consistent styling.
    <div class="@Model.CardCssClass">
        @if (!string.IsNullOrEmpty(Model.Title) || Model.ShowSearchBox || Model.HeaderButtons.Any())
        {
            <!--begin::Card header-->
            <div class="card-header align-items-center py-5 gap-2 gap-md-5">
                <!--begin::Card title-->
                <div class="card-title">
                    @if (!string.IsNullOrEmpty(Model.Title))
                    {
                        <h3 class="card-label">@Model.Title</h3>
                    }
                    @if (Model.ShowSearchBox)
                    {
                        <!--begin::Search-->
                        <div class="d-flex align-items-center position-relative my-1">
                            <i class="ki-duotone ki-magnifier fs-3 position-absolute ms-4">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            <input type="text" id="@(tableId)_search" class="form-control form-control-solid w-250px ps-12" placeholder="@(Model.SearchPlaceholder ?? "Search...")" />
                        </div>
                        <!--end::Search-->
                    }
                </div>
                <!--end::Card title-->
                @if (Model.HeaderButtons.Any())
                {
                    <!--begin::Card toolbar-->
                    <div class="card-toolbar">
                        @foreach (var button in Model.HeaderButtons)
                        {
                            // Render header buttons, typically for actions like "Add New".
                            @if (button.Type == DataTableActionButtonType.Link && !string.IsNullOrEmpty(button.Controller) && !string.IsNullOrEmpty(button.Action))
                            {
                                <a asp-controller="@button.Controller" asp-action="@button.Action" class="@button.CssClass">
                                    @if (!string.IsNullOrEmpty(button.Icon))
                                    {
                                        <i class="@button.Icon"></i>
                                    }
                                    @button.Text
                                </a>
                            }
                            else if (!string.IsNullOrEmpty(button.Url))
                            {
                                <a href="@button.Url" class="@button.CssClass">
                                    @if (!string.IsNullOrEmpty(button.Icon))
                                    {
                                        <i class="@button.Icon"></i>
                                    }
                                    @button.Text
                                </a>
                            }
                        }
                    </div>
                    <!--end::Card toolbar-->
                }
            </div>
            <!--end::Card header-->
        }

        <!--begin::Card body-->
        <div class="card-body pt-0">

            <table class="@Model.CssClass" id="@tableId">
                <thead>
                    <tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase gs-0">
                        @if (hasCheckboxes)
                        {
                            // Checkbox column for row selection.
                            <th class="w-10px pe-2">
                                <div class="form-check form-check-sm form-check-custom form-check-solid me-3">
                                    <input class="form-check-input" type="checkbox" data-kt-check="true" data-kt-check-target="#@tableId .form-check-input" value="1" />
                                </div>
                            </th>
                        }

                        @foreach (var column in Model.Columns.Where(c => c.Visible && !c.Name.Equals("actions", StringComparison.OrdinalIgnoreCase)))
                        {
                            // Dynamically generate table headers from the configuration.
                            <th class="min-w-150px text-start">
                                @column.Title
                            </th>
                        }

                        @if (hasActions)
                        {
                            // "Actions" column header.
                            var actionsColumn = Model.Columns.FirstOrDefault(c => c.Name.Equals("actions", StringComparison.OrdinalIgnoreCase));
                            <th class="text-end min-w-70px">
                                @(actionsColumn?.Title ?? "Actions")
                            </th>
                        }
                    </tr>
                </thead>
                <tbody class="fw-semibold text-gray-600">
                    <!-- Table body is intentionally left empty. DataTables will populate it via client-side or server-side processing. -->
                </tbody>
            </table>
        </div>
        <!--end::Card body-->
    </div>
}

<!-- DataTable Configuration -->
<!-- This script block translates the C# DataTableConfiguration model into a JavaScript object. -->
<!-- This object will be used by the DataTables initialization script. -->
<script type="text/javascript">
    window.@(tableId)Config = {
        // URLs for edit and delete actions, to be used in the 'render' function for the actions column.
        editUrl: '@editUrl',
        deleteUrl: '@deleteUrl',
        // URL for server-side processing to fetch data.
        ajaxUrl: '@Model.AjaxUrl',
        // Boolean flags to control DataTables features.
        hasCheckboxes: @hasCheckboxes.ToString().ToLower(),
        hasActions: @hasActions.ToString().ToLower(),
        serverSide: @Model.ServerSide.ToString().ToLower(),
        paging: @Model.Paging.ToString().ToLower(),
        searching: @Model.Searching.ToString().ToLower(),
        ordering: @Model.Ordering.ToString().ToLower(),
        info: @Model.Info.ToString().ToLower(),
        pageLength: @Model.PageLength,
        responsive: @Model.Responsive.ToString().ToLower(),
        showSearchBox: @Model.ShowSearchBox.ToString().ToLower(),
        // Column definitions for DataTables.
        columns: [
            @if (hasCheckboxes)
            {
                    // Configuration for the checkbox column.
                            <text>{
                                data: null, // No data source property, rendered manually.
                                orderable: false,
                                searchable: false,
                                className: "w-10px pe-2",
                                render: function(data, type, row) {
                                    // Renders a checkbox for each row. The 'id' property of the row data is used as the value.
                                    return '<div class="form-check form-check-sm form-check-custom form-check-solid"><input class="form-check-input" type="checkbox" value="' + (row.id || '') + '" /></div>';
                                }
                            },</text>
            }

            @foreach (var column in Model.Columns.Where(c => c.Visible && !c.Name.Equals("actions", StringComparison.OrdinalIgnoreCase)))
            {
                    // Configuration for a standard data column.
                            <text>{
                                data: "@column.Name", // Maps to a property in the JSON data source.
                                name: "@column.Name", // Name for server-side processing.
                                orderable: @column.Sortable.ToString().ToLower(),
                                searchable: @column.Searchable.ToString().ToLower(),
                                    className: "min-w-250px text-start"
            @if (column.Type == DataTableColumnType.Date)
                                {
                                        // Custom render function for date columns to handle nulls.
                                                <text>,
                                            render: function(data, type, row) {
                                                return data || '';
                                            }</text>
                                }
                            },</text>
            }

            @if (hasActions)
            {
                    // Configuration for the actions column.
                            <text>{
                                data: null, // No data source property, rendered manually.
                                orderable: false,
                                searchable: false,
                                className: "text-end min-w-70px",
                                render: function(data, type, row) {
                                    // Dynamically builds the HTML for the action buttons (Edit, Delete).
                                    var actions = '';
                                    actions += '<a class="btn btn-sm btn-light btn-active-light-primary btn-flex btn-center" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">';
                                    actions += 'Actions <i class="ki-duotone ki-down fs-5 ms-1"></i></a>';
                                    actions += '<div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4" data-kt-menu="true">';

                                    if (window.@(tableId)Config.editUrl) {
                                        actions += '<div class="menu-item px-3">';
                                        actions += '<a href="' + window.@(tableId)Config.editUrl + '/' + (row.id || '') + '" class="menu-link px-3">';
                                        actions += '<i class="ki-duotone ki-pencil"></i> Edit</a>';
                                        actions += '</div>';
                                    }

                                    if (window.@(tableId)Config.deleteUrl) {
                                        actions += '<div class="menu-item px-3">';
                                        actions += '<a href="' + window.@(tableId)Config.deleteUrl + '/' + (row.id || '') + '" class="menu-link px-3 confirm-action" data-message="Are you sure you want to delete this item?">';
                                        actions += '<i class="ki-duotone ki-trash"></i> Delete</a>';
                                        actions += '</div>';
                                    }

                                    actions += '</div>';
                                    return actions;
                                }
                            }</text>
            }
        ]
    };
</script>

<!-- This script block initializes the DataTable and sets up event handlers. -->
<script type="text/javascript">
    $(document).ready(function() {
        // Get the configuration object created in the previous script block.
        var config = window.@(tableId)Config;

        // Build the final DataTables configuration object.
        var tableConfig = {
            serverSide: config.serverSide,
            processing: true, // Shows the "Processing..." indicator.
            paging: config.paging,
            searching: config.searching,
            ordering: config.ordering,
            info: config.info,
            pageLength: config.pageLength,
            responsive: config.responsive,
            language: {
                emptyTable: "@(Model.EmptyTableMessage ?? "No data available in table")",
                processing: '<div class="d-flex justify-content-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>'
            },
            columns: config.columns,
            // Re-initialize Metronic components on each table draw.
            drawCallback: function(settings) {
                KTMenu.init();
            }
        };

        // Add default ordering: ModifiedDate DESC (if column exists)
        (function() {
            // Find index of column whose data property is 'modifieddate' (case-insensitive)
            var modifiedIdx = config.columns.findIndex(function(col) {
                return col && typeof col.data === 'string' && col.data.toLowerCase() === 'modifieddate';
            });
            if (modifiedIdx !== -1) {
                tableConfig.order = [[modifiedIdx, 'desc']];
            }
        })();

        // Add AJAX configuration if server-side processing is enabled.
        if (config.serverSide && config.ajaxUrl) {
            tableConfig.ajax = {
                url: config.ajaxUrl,
                type: "POST",
                dataType: "json"
            };
        }

        // Initialize the DataTable on the table element.
        var table = $('#@tableId').DataTable(tableConfig);

        // to ensure menus in collapsed rows work correctly.
        table.on('responsive-display', function (e, datatable, row, showHide, update) {
            KTMenu.init();
        });

        // Wire up the custom search box if it's enabled.
        if (config.showSearchBox) {
            $('#@(tableId)_search').on('keyup', function() {
                table.search(this.value).draw();
            });
        }

        // Set up a global event handler for actions that require confirmation.
        $(document).on('click', '.confirm-action', function(e) {
            e.preventDefault(); // Prevent the link from being followed immediately.
            var url = $(this).attr('href');
            var message = $(this).data('message') || 'Are you sure?';

            // Use the browser's native confirm dialog.
            if (confirm(message)) {
                window.location.href = url; // Proceed with the action if confirmed.
            }
        });
    });
</script>